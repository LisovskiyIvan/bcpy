# Миграция базы данных VPN сервиса

## Изменения в структуре данных

### До миграции:

- VPN конфигурации были привязаны напрямую к пользователю (`user_id`)
- Один пользователь мог иметь только одну VPN конфигурацию

### После миграции:

- VPN конфигурации привязаны к подпискам (`subscription_id`)
- Пользователь может иметь несколько подписок
- Каждая подписка может иметь свою VPN конфигурацию
- Сохранена связь пользователь -> подписки -> VPN конфигурации

## Выполнение миграции

1. **Остановите приложение** перед выполнением миграции

2. **Запустите скрипт миграции:**

   ```bash
   python migrate_db.py
   ```

3. **Проверьте результат миграции:**
   - Скрипт автоматически обнаружит старую структуру
   - Перенесет данные в новую структуру
   - Сохранит только активные VPN конфигурации для активных подписок

## Новые API эндпоинты

### Получить активную VPN конфигурацию пользователя:

```
GET /api/vpn/{user_id}
```

### Получить все VPN конфигурации пользователя:

```
GET /api/vpn/{user_id}/all
```

### Создать VPN конфигурацию для активной подписки:

```
POST /api/vpn?user_id={user_id}
```

## Изменения в CRUD операциях

### Новые функции:

- `get_subscription_vpn_config()` - получить VPN конфигурацию подписки
- `get_user_active_vpn_config()` - получить активную VPN конфигурацию пользователя
- `get_user_all_vpn_configs()` - получить все VPN конфигурации пользователя

### Обновленные функции:

- `create_vpn_config()` - теперь принимает `subscription_id` вместо `user_id`

## Важные моменты

1. **Один конфиг на подписку**: Каждая подписка может иметь только одну VPN конфигурацию
2. **Автоматическая деактивация**: При истечении подписки VPN конфигурация автоматически деактивируется
3. **Обратная совместимость**: API эндпоинты для работы с пользователями остались прежними
4. **Множественные подписки**: Пользователь может иметь несколько активных подписок одновременно
